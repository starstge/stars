<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom background colors for statuses with transparency */
        .status-beginner { background-color: rgba(255, 255, 255, 0.7); } /* White, more transparent */
        .status-newbie { background-color: rgba(173, 216, 230, 0.6); } /* Light Blue, more transparent */
        .status-buyer { background-color: rgba(144, 238, 144, 0.6); } /* Light Green, more transparent */
        .status-regular-buyer { background-color: rgba(255, 140, 0, 0.6); } /* Vibrant Orange, more transparent */
        .status-verified { background-color: rgba(255, 255, 224, 0.6); } /* Light Yellow, more transparent */
        .status-table tr td { background-color: inherit !important; }

        /* Enhanced table styling */
        table {
            border-collapse: collapse;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        th, td {
            text-align: left;
            transition: background-color 0.2s ease;
        }
        tr:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        select {
            background-color: transparent;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.25rem;
            transition: border-color 0.2s ease;
        }
        select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        button, a.bg-blue-500 {
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        button:hover, a.bg-blue-500:hover {
            transform: translateY(-1px);
        }
        .modal-content {
            transform: scale(0.95);
            transition: transform 0.2s ease;
        }
        #commandModal:not(.hidden) .modal-content {
            transform: scale(1);
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-6">
        <h1 class="text-3xl font-bold mb-6 text-gray-800">Users Management</h1>
        <div class="mb-6 flex space-x-4">
            <a href="{{ url_for('transactions') }}" class="text-blue-600 hover:text-blue-800 font-medium">Back to Transactions</a>
            <a href="{{ url_for('logout') }}" class="text-blue-600 hover:text-blue-800 font-medium">Logout</a>
        </div>

        <!-- Filters -->
        <form method="GET" action="{{ url_for('users') }}" class="mb-6 bg-white p-4 rounded-lg shadow">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="user_id" class="block text-sm font-medium text-gray-700">User ID</label>
                    <input type="number" name="user_id" id="user_id" value="{{ request.args.get('user_id', '') }}"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" name="username" id="username" value="{{ request.args.get('username', '') }}"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="is_admin" class="block text-sm font-medium text-gray-700">Admin Status</label>
                    <select name="is_admin" id="is_admin" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All</option>
                        <option value="true" {% if request.args.get('is_admin') == 'true' %}selected{% endif %}>Admin</option>
                        <option value="false" {% if request.args.get('is_admin') == 'false' %}selected{% endif %}>Non-Admin</option>
                    </select>
                </div>
                <div>
                    <label for="prefix" class="block text-sm font-medium text-gray-700">Prefix</label>
                    <select name="prefix" id="prefix" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All</option>
                        <option value="Beginner" {% if request.args.get('prefix') == 'Beginner' %}selected{% endif %}>Beginner</option>
                        <option value="Newbie" {% if request.args.get('prefix') == 'Newbie' %}selected{% endif %}>Newbie</option>
                        <option value="Buyer" {% if request.args.get('prefix') == 'Buyer' %}selected{% endif %}>Buyer</option>
                        <option value="Regular Buyer" {% if request.args.get('prefix') == 'Regular Buyer' %}selected{% endif %}>Regular Buyer</option>
                        <option value="Verified" {% if request.args.get('prefix') == 'Verified' %}selected{% endif %}>Verified</option>
                    </select>
                </div>
            </div>
            <div class="mt-4 flex space-x-2">
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Filter</button>
                <a href="{{ url_for('users') }}" class="text-blue-600 hover:text-blue-800 font-medium pt-2">Clear Filters</a>
            </div>
        </form>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-6 bg-white p-4 rounded-lg shadow">
                    {% for category, message in messages %}
                        <p class="text-{{ 'red' if category == 'error' else 'green' }}-600 font-medium">{{ message }}</p>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Users Table -->
        <div class="overflow-x-auto bg-white rounded-lg shadow">
            <table class="min-w-full border border-gray-200">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="py-3 px-4 border-b text-gray-700 font-semibold">User ID</th>
                        <th class="py-3 px-4 border-b text-gray-700 font-semibold">Username</th>
                        <th class="py-3 px-4 border-b text-gray-700 font-semibold">Stars Bought</th>
                        <th class="py-3 px-4 border-b text-gray-700 font-semibold">Ref Bonus TON</th>
                        <th class="py-3 px-4 border-b text-gray-700 font-semibold">Referrals</th>
                        <th class="py-3 px-4 border-b text-gray-700 font-semibold">Created At</th>
                        <th class="py-3 px-4 border-b text-gray-700 font-semibold">Is New</th>
                        <th class="py-3 px-4 border-b text-gray-700 font-semibold">Is Admin</th>
                        <th class="py-3 px-4 border-b text-gray-700 font-semibold">Prefix</th>
                        <th class="py-3 px-4 border-b text-gray-700 font-semibold">Referrer ID</th>
                        <th class="py-3 px-4 border-b text-gray-700 font-semibold">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr class="{% if user.is_admin %}status-verified{% elif user.prefix == 'Verified' %}status-verified{% elif user.prefix == 'Regular Buyer' %}status-regular-buyer{% elif user.prefix == 'Buyer' %}status-buyer{% elif user.prefix == 'Newbie' %}status-newbie{% else %}status-beginner{% endif %}">
                        <td class="py-2 px-4 border-b">{{ user.user_id }}</td>
                        <td class="py-2 px-4 border-b">{{ user.username or 'N/A' }}</td>
                        <td class="py-2 px-4 border-b">{{ user.stars_bought }}</td>
                        <td class="py-2 px-4 border-b">{{ user.ref_bonus_ton }}</td>
                        <td class="py-2 px-4 border-b">{{ user.referrals | length }}</td>
                        <td class="py-2 px-4 border-b">{{ user.created_at }}</td>
                        <td class="py-2 px-4 border-b">{{ 'Yes' if user.is_new else 'No' }}</td>
                        <td class="py-2 px-4 border-b">
                            <select onchange="updateUserStatus('is_admin', {{ user.user_id }}, this.value)" style="background-color: transparent;">
                                <option value="true" {% if user.is_admin %}selected{% endif %}>Admin</option>
                                <option value="false" {% if not user.is_admin %}selected{% endif %}>Non-Admin</option>
                            </select>
                        </td>
                        <td class="py-2 px-4 border-b">
                            <select onchange="updateUserStatus('prefix', {{ user.user_id }}, this.value)" style="background-color: transparent;">
                                <option value="Beginner" {% if user.prefix == 'Beginner' %}selected{% endif %}>Beginner</option>
                                <option value="Newbie" {% if user.prefix == 'Newbie' %}selected{% endif %}>Newbie</option>
                                <option value="Buyer" {% if user.prefix == 'Buyer' %}selected{% endif %}>Buyer</option>
                                <option value="Regular Buyer" {% if user.prefix == 'Regular Buyer' %}selected{% endif %}>Regular Buyer</option>
                                <option value="Verified" {% if user.prefix == 'Verified' %}selected{% endif %}>Verified</option>
                            </select>
                        </td>
                        <td class="py-2 px-4 border-b">{{ user.referrer_id or 'N/A' }}</td>
                        <td class="py-2 px-4 border-b">
                            <button onclick="openCommandModal({{ user.user_id }})" class="text-blue-600 hover:text-blue-800 font-medium">Generate Command</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="mt-6 flex justify-between items-center">
            {% if page > 1 %}
            <a href="{{ url_for('users', page=page-1, user_id=request.args.get('user_id', ''), username=request.args.get('username', ''), is_admin=request.args.get('is_admin', ''), prefix=request.args.get('prefix', '')) }}"
               class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Previous</a>
            {% else %}
            <span class="bg-gray-300 text-gray-600 px-4 py-2 rounded-md cursor-not-allowed">Previous</span>
            {% endif %}
            <span class="text-gray-700 font-medium">Page {{ page }} of {{ total_pages }}</span>
            {% if page < total_pages %}
            <a href="{{ url_for('users', page=page+1, user_id=request.args.get('user_id', ''), username=request.args.get('username', ''), is_admin=request.args.get('is_admin', ''), prefix=request.args.get('prefix', '')) }}"
               class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Next</a>
            {% else %}
            <span class="bg-gray-300 text-gray-600 px-4 py-2 rounded-md cursor-not-allowed">Next</span>
            {% endif %}
        </div>

        <!-- Status Table -->
        <div class="mt-8 bg-white p-4 rounded-lg shadow">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Status Table</h2>
            <table class="min-w-full border border-gray-200 status-table">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="py-3 px-4 border-b text-gray-700 font-semibold">Prefix</th>
                        <th class="py-3 px-4 border-b text-gray-700 font-semibold">Criteria</th>
                        <th class="py-3 px-4 border-b text-gray-700 font-semibold">Background Color</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="status-beginner">
                        <td class="py-2 px-4 border-b">Beginner</td>
                        <td class="py-2 px-4 border-b">0 stars</td>
                        <td class="py-2 px-4 border-b">White (Transparent)</td>
                    </tr>
                    <tr class="status-newbie">
                        <td class="py-2 px-4 border-b">Newbie</td>
                        <td class="py-2 px-4 border-b">≥1000 stars</td>
                        <td class="py-2 px-4 border-b">Light Blue (Transparent)</td>
                    </tr>
                    <tr class="status-buyer">
                        <td class="py-2 px-4 border-b">Buyer</td>
                        <td class="py-2 px-4 border-b">≥5000 stars</td>
                        <td class="py-2 px-4 border-b">Light Green (Transparent)</td>
                    </tr>
                    <tr class="status-regular-buyer">
                        <td class="py-2 px-4 border-b">Regular Buyer</td>
                        <td class="py-2 px-4 border-b">≥10000 stars</td>
                        <td class="py-2 px-4 border-b">Vibrant Orange (Transparent)</td>
                    </tr>
                    <tr class="status-verified">
                        <td class="py-2 px-4 border-b">Verified</td>
                        <td class="py-2 px-4 border-b">≥50000 stars or Admin</td>
                        <td class="py-2 px-4 border-b">Light Yellow (Transparent)</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Command Generator Modal -->
        <div id="commandModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center">
            <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg modal-content">
                <h2 class="text-xl font-bold mb-4 text-gray-800">Generate SQL Command</h2>
                <div class="mb-4">
                    <label for="commandTable" class="block text-sm font-medium text-gray-700">Table</label>
                    <select id="commandTable" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="users">users</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="commandAction" class="block text-sm font-medium text-gray-700">Action</label>
                    <select id="commandAction" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="find">Find User</option>
                        <option value="update_admin">Update Admin Status</option>
                        <option value="update_prefix">Update Prefix</option>
                        <option value="update_details">Update User Details</option>
                        <option value="delete">Delete User</option>
                        <option value="sort_users_by_stars">Sort Users by Stars</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="commandId" class="block text-sm font-medium text-gray-700">User ID</label>
                    <input type="number" id="commandId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div id="extraFields" class="mb-4 hidden">
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="usernameField" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <label for="starsBought" class="block text-sm font-medium text-gray-700 mt-2">Stars Bought</label>
                    <input type="number" id="starsBought" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <label for="refBonusTon" class="block text-sm font-medium text-gray-700 mt-2">Ref Bonus TON</label>
                    <input type="number" step="0.01" id="refBonusTon" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <label for="prefix" class="block text-sm font-medium text-gray-700 mt-2">Prefix</label>
                    <select id="prefixField" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="Beginner">Beginner</option>
                        <option value="Newbie">Newbie</option>
                        <option value="Buyer">Buyer</option>
                        <option value="Regular Buyer">Regular Buyer</option>
                        <option value="Verified">Verified</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="commandOutput" class="block text-sm font-medium text-gray-700">Generated Command</label>
                    <textarea id="commandOutput" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500" readonly></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button onclick="closeCommandModal()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Close</button>
                    <button onclick="generateCommand()" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Generate</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function openCommandModal(userId) {
            document.getElementById('commandModal').classList.remove('hidden');
            document.getElementById('commandId').value = userId;
            toggleExtraFields();
        }

        function closeCommandModal() {
            document.getElementById('commandModal').classList.add('hidden');
            document.getElementById('commandOutput').textContent = '';
            document.getElementById('extraFields').classList.add('hidden');
        }

        function toggleExtraFields() {
            const action = document.getElementById('commandAction').value;
            const extraFields = document.getElementById('extraFields');
            extraFields.classList.toggle('hidden', action !== 'update_details');
        }

        document.getElementById('commandAction').addEventListener('change', toggleExtraFields);

        function generateCommand() {
            const table = document.getElementById('commandTable').value;
            const action = document.getElementById('commandAction').value;
            const id = document.getElementById('commandId').value.trim();
            const username = document.getElementById('usernameField')?.value.trim();
            const starsBought = document.getElementById('starsBought')?.value.trim();
            const refBonusTon = document.getElementById('refBonusTon')?.value.trim();
            const prefix = document.getElementById('prefixField')?.value;
            const output = document.getElementById('commandOutput');
            let command = '';

            if (action !== 'sort_users_by_stars' && (!id || isNaN(id))) {
                output.textContent = 'Please enter a valid numeric User ID.';
                return;
            }

            const queryTemplates = {
                users: {
                    find: 'SELECT * FROM users WHERE user_id = $1;',
                    update_admin: 'UPDATE users SET is_admin = $2 WHERE user_id = $1;',
                    update_prefix: 'UPDATE users SET prefix = $2 WHERE user_id = $1;',
                    update_details: 'UPDATE users SET {updates} WHERE user_id = $1;',
                    delete: 'DELETE FROM users WHERE user_id = $1;',
                    sort_users_by_stars: `SELECT u.user_id, u.username, u.is_admin, u.prefix, COALESCE(SUM(t.stars_amount), 0) as total_stars
                        FROM users u
                        LEFT JOIN transactions t ON u.user_id = t.user_id
                        GROUP BY u.user_id, u.username, u.is_admin, u.prefix
                        ORDER BY total_stars DESC;`
                }
            };

            if (!queryTemplates[table][action]) {
                output.textContent = 'Invalid table or action.';
                return;
            }

            if (action === 'update_details') {
                let updates = [];
                let params = [id];
                let paramIndex = 2;

                if (username) {
                    updates.push(`username = $${paramIndex}`);
                    params.push(username.replace(/'/g, "''"));
                    paramIndex++;
                }
                if (starsBought && !isNaN(starsBought)) {
                    updates.push(`stars_bought = $${paramIndex}`);
                    params.push(parseInt(starsBought));
                    paramIndex++;
                }
                if (refBonusTon && !isNaN(refBonusTon)) {
                    updates.push(`ref_bonus_ton = $${paramIndex}`);
                    params.push(parseFloat(refBonusTon).toFixed(2));
                    paramIndex++;
                }
                if (prefix) {
                    updates.push(`prefix = $${paramIndex}`);
                    params.push(prefix);
                    paramIndex++;
                }

                if (updates.length === 0) {
                    output.textContent = 'Please enter at least one value to update.';
                    return;
                }

                command = queryTemplates[table][action].replace('{updates}', updates.join(', '));
            } else if (action === 'update_admin') {
                command = queryTemplates[table][action].replace('$2', `true`);
            } else if (action === 'update_prefix') {
                const prefixValue = prompt('Enter prefix (Beginner, Newbie, Buyer, Regular Buyer, Verified):');
                if (!['Beginner', 'Newbie', 'Buyer', 'Regular Buyer', 'Verified'].includes(prefixValue)) {
                    output.textContent = 'Invalid prefix value.';
                    return;
                }
                command = queryTemplates[table][action].replace('$2', `'${prefixValue}'`);
            } else {
                command = queryTemplates[table][action];
            }

            output.textContent = command;
        }

        async function updateUserStatus(field, userId, value) {
            try {
                const response = await fetch('/update_status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'user', field, user_id: userId, value })
                });
                const result = await response.json();
                alert(result.message);
                if (!response.ok) location.reload();
            } catch (error) {
                alert('Error updating status: ' + error.message);
                location.reload();
            }
        }
    </script>
</body>
</html>
